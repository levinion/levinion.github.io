<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y1H2WQ3TCQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y1H2WQ3TCQ');
</script>

<title>Nonebot2-插件编写入门指北 | Maruka&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="指北请注意 nonebot2 是一个由 python 编写的跨平台异步机器人框架，对那些想拥有一个自己的机器人的人来说，nonebot2 是一个理想的选择。nonebot2 学">
<meta name="author" content="Maruka">
<link rel="canonical" href="https://levinion.github.io/posts/nonebot2-%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.757d1a97e1f4f91158d2550c3b4f97677d99c03ce0054185ddf481dbf8d537f4.css" integrity="sha256-dX0al&#43;H0&#43;RFY0lUMO0&#43;XZ32ZwDzgBUGF3fSB2/jVN/Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://levinion.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://levinion.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://levinion.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://levinion.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://levinion.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y1H2WQ3TCQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-Y1H2WQ3TCQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Nonebot2-插件编写入门指北" />
<meta property="og:description" content="指北请注意 nonebot2 是一个由 python 编写的跨平台异步机器人框架，对那些想拥有一个自己的机器人的人来说，nonebot2 是一个理想的选择。nonebot2 学" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://levinion.github.io/posts/nonebot2-%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-29T13:37:42&#43;08:00" />
<meta property="article:modified_time" content="2022-11-29T13:37:42&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nonebot2-插件编写入门指北"/>
<meta name="twitter:description" content="指北请注意 nonebot2 是一个由 python 编写的跨平台异步机器人框架，对那些想拥有一个自己的机器人的人来说，nonebot2 是一个理想的选择。nonebot2 学"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://levinion.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Nonebot2-插件编写入门指北",
      "item": "https://levinion.github.io/posts/nonebot2-%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Nonebot2-插件编写入门指北",
  "name": "Nonebot2-插件编写入门指北",
  "description": "指北请注意 nonebot2 是一个由 python 编写的跨平台异步机器人框架，对那些想拥有一个自己的机器人的人来说，nonebot2 是一个理想的选择。nonebot2 学",
  "keywords": [
    
  ],
  "articleBody": "指北请注意 nonebot2 是一个由 python 编写的跨平台异步机器人框架，对那些想拥有一个自己的机器人的人来说，nonebot2 是一个理想的选择。nonebot2 学习门槛不高——你所需要的只是一些 python 基础。如果你没有学过 python，但有其他编程语言基础，那也没有关系；因为我也将近一年多没有接触过 python 编程，和初学者没有什么两样，因此如果代码稀烂的话还请多多谅解。\n写这篇文章的部分原因是因为官网的教程过于简约（？）或零碎，而且少有代码范例，对想要深入实践编写插件的人造成了一定困难；另一部分也是作为这几天编写插件经验的总结。本文风格偏重实践，并不打算事无巨细地讲清楚内在原理；这其实是我知识不足的原因。因此如果想要同时搞清楚理论的话，我会尽量给出参考的链接。如果正在阅读这篇文章的你能够知道“我写这篇文章的同时也是在和你一同学习”的话，那可就太好了。\n\u003e 在正文开始前，你应当已经做到了以下几点：\n已经配置好 nonebot2 开发环境 具备一定的 python 基础（如果有其他编程语言经验，至少具备查阅资料的能力） 积极动手实践 \u003e这篇文章的大体思路如下：\nHello World 以我自己编写的插件 “sumi” 为例，你能够学会： 对戳一戳事件的回应 命令参数 自定义规则 读取环境配置 json 保存和读取数据 发送和下载图片到本地（没错，就是偷图功能哒！） 行了，废话不多说，让我们开始吧。\n1 Hello World 正如每种语言都从输出 “hello world” 开始那样，我们的第一个插件尝试让 bot 发送一条 “hello world” 信息给用户。\n1.1 准备 - 项目文件结构 在开始正式编写插件之前，我们先了解一下插件编写的文件结构。\n1 2 3 4 5 6 7 8 . ├── bot.py ├── docker-compose.yml ├── Dockerfile ├── firststep │ └── plugins ├── pyproject.toml └── README.md 这是刚刚创建项目时所具有的最简文件结构。我们所编写的插件应当放在 {项目名}/plugins 文件夹下。 bot.py 是程序的入口，负责插件的调用。\n1 2 3 4 . └── plugins └── hello_world └── __init__.py 首先在 plugins 目录下创建名为 hello_world 的文件夹，此即插件名称；插件主程序一般命名为 __init__.py 。\n如果你想要将插件发布到商店，按照规范，插件名称应当以 nonebot-plugin- 或 nonebot_plugin_ 开头，本文为练习方便起见，不遵循此规定。\n1.2 始动 - hello world 程序 1 2 3 4 5 6 from nonebot import on_command hello_world = on_command(\"hi\") @hello_world.handle() async def _(): await hello_world.send(\"hello world\") 短短六行代码即可完成整个工作流（请忽略中间的那个空行喵）：\n响应器接收到用户发送的指令 “hi”； 通过 handle 装饰器进入到插件的运行流程； 然后异步函数向用户发送信息。 具体的响应器类型请参考官网内容—— 定义事件响应器。\n1.3 进阶 - 由 hello world 过渡到实用插件 通过以上代码，我们已经实现 bot 向用户发送信息。如果加上事件处理，就能够实现更多实用功能。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import ... hello_world = on_command(...) @hello_world.handle() async def _(): # 返回数据的请求api api=... # 由api请求数据 ... data=... # 处理得到数据，生成发送用户的信息 ... message=... await hello_world.send(message) 2 正式开始？——其实已经结束了 2.1 第一步 - poke 行为触发 1 2 3 4 5 6 7 8 9 10 11 from nonebot.adapters.onebot.v11 import MessageSegment，PokeNotifyEvent from nonebot import on_notice def _poke_check(event:PokeNotifyEvent): return event.target_id==event.self_id poke=on_notice(rule=_poke_check,priority=5,block=True) @poke.handle() async def _(event:PokeNotifyEvent): user_id=event.get_user_id() await poke.finish(MessageSegment.at(user_id)+Message(\"hi\") 这是一段检测 poke 行为并进行回复的简易程序，下面我们将对其进行讲解。\n首先我们定义了一个用以检验 poke 行为的自定义规则。PokeNotifyEvent 是一个 Poke 事件，当该事件作用的对象为机器人本身时，进入响应器的作用流程。\non_notice()注册了一个消息事件响应器。自定义规则通过 rule 传递给响应器，priority指定响应器的作用优先级，block=True时不再响应优先级更低的事件。\nMessageSegment 是一个非常好用的工具。在 nonebot 中，我们想要发送图片，或@某人等特殊信息，通常使用 CQ 码。MessageSegment 对 CQ 码进行包装，使其更加容易编写。此处我们使用 MessageSegment.at() 函数，实现了@某人的效果。\n当我们要实现一个动作时，往往需要提前告知动作作用的对象。event.get_user_id() 返回 string 格式的用户 qq 号。\nMessageSegment返回一个Message对象，能够和其他Message对象相加，合并成一个消息列表。因此最后发送给用户的信息应当是：“@用户名hi”。\n2.2 第二步 - 叫我主人大人！ 有时我们需要从用户发送的消息中抽取有用的信息，并对其进行处理或存储。这通常使用 CommandArg 来实现。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 call_me=on_command(\"叫我\",rule=to_me()\u0026 Rule(is_super_user),priority=8) @call_me.handle() async def _(event:Event,args:Message=CommandArg()): arg:List[str]=args.extract_plain_text().strip().split() user_id=event.get_user_id() if len(arg)!=1: await call_me.finish(MessageSegment.at(user_id)+Message(\"没有那样的称呼啦！\")) else: oyobi=arg[0] config_file=f\"{os.path.dirname(__file__)}/config.json\" with open(config_file,\"r\") as file: try: content=json.load(file) except: content={} content.setdefault(user_id,{}).setdefault(\"oyobi\",oyobi) with open(config_file,\"w\") as file: json.dump(content,file,ensure_ascii=False) await call_me.finish(MessageSegment.at(user_id)+Message(f\"好的哦，{oyobi}!\")) CommandArg 获取的消息是一个 Message 对象，需要使用 extract. plain_text() 函数返回一个消息字符串。当然你也可以使用 split 方法对这个字符串进行切割，从而返回一个 string 列表。我在上面的示例中就是这样做的。我通过 if else 语句强制规定该响应器只能接受一个参数。\noyobi 变量成功保存了接受到的命令参数，接着就是 python 中基本的文件操作。这里你需要掌握的是 json 文件的操作。json 格式文件常用于 nonebot 中的数据保存。由于不需要建立数据库，只需要操作文件，所以方便快捷。对 json 的操作一般包括增删改查，流程大都是通过调用 json.load() 和 json.dump() 两个函数。json.load() 函数用以读取 json 格式信息并转化为字典或列表格式的变量。json.dump() 函数将 python 中的数据格式，如字典或列表转化为 json 格式数据并写入文件中。在要保存的数据中包括 cjk 字符（中文或日文等）的情况下，建议将 json.dump() 函数中的 ensure_ascii 参数置为 False，否则 cjk 字符将被保存为 ascii 码导致阅读困难。\n学会json的操作，你就可以写下一个响应器，让机器人叫你你喜欢的名字了（比如ご主人様之类）。\n2.3 第三步 - 你到底是不是我的主人？ 说是例子，其实更恰当地来讲不过是工具函数罢了。判断是否超管在实现某些功能时很有必要，比如对你示爱，对其他人冷眼以对的超级棒的机器人。自定义规则适用于响应器中事件的判断，如果你想要对响应器是否执行进行判断（如果不符合，不进入响应器），可以使用 nonebot.rule 中封装好的规则，如to_me等，或 nonebot.permission 中的封装好的权限，如SUPERUSER。\n1 2 3 4 5 6 7 8 9 10 11 12 13 import nonebot def is_super_user(event:Event): \"\"\" 判断当前交互对象是否超级管理员 \"\"\" return event.get_user_id() in nonebot.get_driver().config.superusers def is_not_super_user(event:Event): \"\"\" 判断当前交互对象是否不是超级管理员 \"\"\" return event.get_user_id() not in nonebot.get_driver().config.superusers 全局配置文件由工程文件夹下的 .env 指定，通常为 .env.dev 或 .env.prod。事实上，读取配置在官网上给出了至少三种方法，我这里只给出一种，其他请自行上官网查看。你可以通过 nonebot.get_driver().config，从驱动器中获取配置文件。值得注意的是，配置文件中的 key 不区分大小写（事实上，一般都用大写），而插件中只能使用小写。\n1 2 3 4 5 6 7 8 9 10 11 12 def _poke_check(event:PokeNotifyEvent): return event.target_id==event.self_id poke=on_notice(rule=_poke_check,priority=5) @poke.handle() async def _(event:PokeNotifyEvent): user_id=event.get_user_id() if is_super_user(event): mes=MessageSegment.image(f\"file:///{img}\")+MessageSegment.at(user_id)+Message(\"贴贴～\") await poke.finish(mes) else: await poke.finish(MessageSegment.at(user_id)+Message(\"滚\")) 稍稍修改第一个程序即可收获秀恩爱机器人一名，以及所有尝试戳机器人的人的无情谩骂（别问我怎么知道的）\n2.4 第四步 - 好图，我的了！ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 图片收集 def _img_check(event: Event): if is_super_user(event): return str(event.get_message()).startswith(\"[CQ:image\") and to_me() else: return str(event.get_message()).startswith(\"[CQ:image\") and prepare(60) collect=on_message(rule=_img_check,priority=100,block=True) @collect.handle() async def _collect(event: Event): try: mes=event.get_message() pic=str(mes) url=re.search(r\"http.*]\",pic).group().removesuffix(\"]\") uuid_str = uuid.uuid4().hex r=httpx.get(url) img=f\"{img_dir_path}/default/{uuid_str}.jpg\" with open(img,\"wb\") as file: file.write(r.content) await collect.finish(\"好图，我的了\") except: logger.error(\"糟糕，没能抓到图(QAQ)\") 机器人的自主学习使我们梦寐以求的。偷图虽然离自主学习还很遥远（其实根本八竿子打不着），但偷图依然是一项实用的功能。\n现在你已经掌握了编写插件所具有的基本知识，因此我想到了这步，只是提示一下思路就已经足够了。\n正如我们前面所说，cq-http 中一些复杂消息类型，如@或图片等均是通过 CQ 码实现的。因此我们接收到的图片应当是类似 [CQ:image,...,url=http://xxx.com/xxx.jpg] 的格式，因此我们可以使用一些方式，如正则或 json 的方式获取消息中的 url，并且利用 request 或着 httpx 将 url 的图片下载到本地。\n2.5 第五步 - 随机回复 1 2 3 4 5 6 7 8 9 10 11 12 13 # 随机回复 def _reply_check(): return prepare(10) reply=on_message(rule=_reply_check,priority=130) @reply.handle() async def _reply(): try: img_default_list=os.listdir(f\"{img_dir_path}/default\") img=f\"{img_dir_path}/default/{random.choice(img_default_list)}\" await reply.send(MessageSegment.image(f\"file:///{img}\")) except: logger.error(\"reply不小心出错了诶嘿\") 随机回复一般用于让机器人群聊中加入聊天话题，此功能被证明干扰性较强，因此慎用。不知你有没有注意到，在上个程序中和这个程序中都用到了 prepare() 函数。prepare 函数是我定义的一个工具函数，用以确定触发概率。其定义如下：\n1 2 3 4 5 def prepare(s:int=10): \"\"\" 概率函数,参数 s 决定概率是 s% \"\"\" return random.random()*100 \u003c s 给出了这个函数，结合你学到的知识，你应该能够轻松看懂这个程序，因此就程序不做讲解了。与之相比，我想要说的是干扰性的问题。我们通常难以对概率有一个清楚的认知，要知道，一般抽卡手游的概率可是2%左右，即使是10%的概率也是天文数字。在一个活跃的群里，10%的概率意味着每隔几秒机器人就会发一次言；但是在一个冷门的群里，大家一天只发一两句话，那么机器人几乎不可能发言。在后一种情况下，这个功能其实可有可无，也不存在干扰的问题；但在前者，我们就需要降低概率，甚至添加冷却时间以防止连续触发。\n",
  "wordCount" : "3755",
  "inLanguage": "zh",
  "datePublished": "2022-11-29T13:37:42+08:00",
  "dateModified": "2022-11-29T13:37:42+08:00",
  "author":{
    "@type": "Person",
    "name": "Maruka"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://levinion.github.io/posts/nonebot2-%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Maruka's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://levinion.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://levinion.github.io" accesskey="h" title="Maruka&#39;s Blog (Alt + H)">Maruka&#39;s Blog</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://levinion.github.io/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://levinion.github.io/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://levinion.github.io/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://levinion.github.io/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://levinion.github.io/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://levinion.github.io">主页</a>&nbsp;»&nbsp;<a href="https://levinion.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Nonebot2-插件编写入门指北
    </h1>
    <div class="post-meta"><span title='2022-11-29 13:37:42 +0800 CST'>十一月 29, 2022</span>&nbsp;·&nbsp;8 分钟&nbsp;·&nbsp;Maruka

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%8c%87%e5%8c%97%e8%af%b7%e6%b3%a8%e6%84%8f" aria-label="指北请注意">指北请注意</a></li>
                <li>
                    <a href="#1-hello-world" aria-label="1 Hello World">1 Hello World</a><ul>
                        
                <li>
                    <a href="#11-%e5%87%86%e5%a4%87---%e9%a1%b9%e7%9b%ae%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84" aria-label="1.1 准备 - 项目文件结构">1.1 准备 - 项目文件结构</a></li>
                <li>
                    <a href="#12-%e5%a7%8b%e5%8a%a8---hello-world-%e7%a8%8b%e5%ba%8f" aria-label="1.2 始动 - hello world 程序">1.2 始动 - hello world 程序</a></li>
                <li>
                    <a href="#13-%e8%bf%9b%e9%98%b6---%e7%94%b1-hello-world-%e8%bf%87%e6%b8%a1%e5%88%b0%e5%ae%9e%e7%94%a8%e6%8f%92%e4%bb%b6" aria-label="1.3 进阶 - 由 hello world 过渡到实用插件">1.3 进阶 - 由 hello world 过渡到实用插件</a></li></ul>
                </li>
                <li>
                    <a href="#2-%e6%ad%a3%e5%bc%8f%e5%bc%80%e5%a7%8b%e5%85%b6%e5%ae%9e%e5%b7%b2%e7%bb%8f%e7%bb%93%e6%9d%9f%e4%ba%86" aria-label="2 正式开始？——其实已经结束了">2 正式开始？——其实已经结束了</a><ul>
                        
                <li>
                    <a href="#21-%e7%ac%ac%e4%b8%80%e6%ad%a5---poke-%e8%a1%8c%e4%b8%ba%e8%a7%a6%e5%8f%91" aria-label="2.1 第一步 - poke 行为触发">2.1 第一步 - poke 行为触发</a></li>
                <li>
                    <a href="#22-%e7%ac%ac%e4%ba%8c%e6%ad%a5---%e5%8f%ab%e6%88%91%e4%b8%bb%e4%ba%ba%e5%a4%a7%e4%ba%ba" aria-label="2.2 第二步 - 叫我主人大人！">2.2 第二步 - 叫我主人大人！</a></li>
                <li>
                    <a href="#23-%e7%ac%ac%e4%b8%89%e6%ad%a5---%e4%bd%a0%e5%88%b0%e5%ba%95%e6%98%af%e4%b8%8d%e6%98%af%e6%88%91%e7%9a%84%e4%b8%bb%e4%ba%ba" aria-label="2.3 第三步 - 你到底是不是我的主人？">2.3 第三步 - 你到底是不是我的主人？</a></li>
                <li>
                    <a href="#24-%e7%ac%ac%e5%9b%9b%e6%ad%a5---%e5%a5%bd%e5%9b%be%e6%88%91%e7%9a%84%e4%ba%86" aria-label="2.4 第四步 - 好图，我的了！">2.4 第四步 - 好图，我的了！</a></li>
                <li>
                    <a href="#25-%e7%ac%ac%e4%ba%94%e6%ad%a5---%e9%9a%8f%e6%9c%ba%e5%9b%9e%e5%a4%8d" aria-label="2.5 第五步 - 随机回复">2.5 第五步 - 随机回复</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="指北请注意">指北请注意<a hidden class="anchor" aria-hidden="true" href="#指北请注意">#</a></h2>
<p>nonebot2 是一个由 python 编写的跨平台异步机器人框架，对那些想拥有一个自己的机器人的人来说，nonebot2 是一个理想的选择。nonebot2 学习门槛不高——你所需要的只是一些 python 基础。如果你没有学过 python，但有其他编程语言基础，那也没有关系；因为我也将近一年多没有接触过 python 编程，和初学者没有什么两样，因此<s>如果代码稀烂的话还请多多谅解</s>。</p>
<p>写这篇文章的部分原因是因为官网的教程过于简约（？）或零碎，而且少有代码范例，对想要深入实践编写插件的人造成了一定困难；另一部分也是作为这几天编写插件经验的总结。本文风格偏重实践，并不打算事无巨细地讲清楚内在原理；这其实是我知识不足的原因。因此如果想要同时搞清楚理论的话，我会尽量给出参考的链接。如果正在阅读这篇文章的你能够知道“我写这篇文章的同时也是在和你一同学习”的话，那可就太好了。</p>
<p><em style="color:pink">&gt; 在正文开始前，你应当已经做到了以下几点：</em></p>
<ul>
<li><input disabled="" type="checkbox"> <span style="color:aqua"> 已经配置好 nonebot2 开发环境</span></li>
<li><input disabled="" type="checkbox"> <span style="color: aqua"> 具备一定的 python 基础（如果有其他编程语言经验，至少具备查阅资料的能力）</span></li>
<li><input disabled="" type="checkbox"> <span style="color:aqua"> 积极动手实践</span></li>
</ul>
<p><em style="color:pink">&gt;这篇文章的大体思路如下：</em></p>
<ol>
<li>Hello World</li>
<li>以我自己编写的插件 “sumi” 为例，你能够学会：</li>
</ol>
<ul>
<li>对戳一戳事件的回应</li>
<li>命令参数</li>
<li>自定义规则</li>
<li>读取环境配置</li>
<li>json 保存和读取数据</li>
<li>发送和下载图片到本地（没错，就是偷图功能哒！）</li>
</ul>
<p>行了，废话不多说，让我们开始吧。</p>
<h2 id="1-hello-world">1 Hello World<a hidden class="anchor" aria-hidden="true" href="#1-hello-world">#</a></h2>
<p>正如每种语言都从输出 &ldquo;hello world&rdquo; 开始那样，我们的第一个插件尝试让 bot 发送一条 &ldquo;hello world&rdquo; 信息给用户。</p>
<h3 id="11-准备---项目文件结构">1.1 准备 - 项目文件结构<a hidden class="anchor" aria-hidden="true" href="#11-准备---项目文件结构">#</a></h3>
<p>在开始正式编写插件之前，我们先了解一下插件编写的文件结构。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.  
</span></span><span class="line"><span class="cl">├── bot.py  
</span></span><span class="line"><span class="cl">├── docker-compose.yml  
</span></span><span class="line"><span class="cl">├── Dockerfile  
</span></span><span class="line"><span class="cl">├── firststep  
</span></span><span class="line"><span class="cl">│   └── plugins  
</span></span><span class="line"><span class="cl">├── pyproject.toml  
</span></span><span class="line"><span class="cl">└── README.md
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是刚刚创建项目时所具有的最简文件结构。我们所编写的插件应当放在 <code>{项目名}/plugins</code> 文件夹下。 <code>bot.py</code> 是程序的入口，负责插件的调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.  
</span></span><span class="line"><span class="cl">└── plugins  
</span></span><span class="line"><span class="cl">   └── hello_world  
</span></span><span class="line"><span class="cl">       └── __init__.py
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先在 <code>plugins</code> 目录下创建名为 <code>hello_world</code> 的文件夹，此即插件名称；插件主程序一般命名为 <code>__init__.py</code> 。</p>
<blockquote>
<p>如果你想要将插件发布到商店，按照规范，插件名称应当以 <code>nonebot-plugin-</code> 或 <code>nonebot_plugin_</code> 开头，本文为练习方便起见，不遵循此规定。</p>
</blockquote>
<h3 id="12-始动---hello-world-程序">1.2 始动 - hello world 程序<a hidden class="anchor" aria-hidden="true" href="#12-始动---hello-world-程序">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">nonebot</span> <span class="kn">import</span> <span class="n">on_command</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">hello_world</span> <span class="o">=</span> <span class="n">on_command</span><span class="p">(</span><span class="s2">&#34;hi&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@hello_world.handle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">_</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="n">hello_world</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;hello world&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>短短六行代码即可完成整个工作流（请忽略中间的那个空行喵）：</p>
<ol>
<li>响应器接收到用户发送的指令 “hi”；</li>
<li>通过 <code>handle</code> 装饰器进入到插件的运行流程；</li>
<li>然后异步函数向用户发送信息。</li>
</ol>
<p>具体的响应器类型请参考官网内容—— <a href="https://nb2.baka.icu/docs/tutorial/plugin/create-matcher">定义事件响应器</a>。</p>
<h3 id="13-进阶---由-hello-world-过渡到实用插件">1.3 进阶 - 由 hello world 过渡到实用插件<a hidden class="anchor" aria-hidden="true" href="#13-进阶---由-hello-world-过渡到实用插件">#</a></h3>
<p>通过以上代码，我们已经实现 bot 向用户发送信息。如果加上事件处理，就能够实现更多实用功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">hello_world</span> <span class="o">=</span> <span class="n">on_command</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@hello_world.handle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">_</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 返回数据的请求api</span>
</span></span><span class="line"><span class="cl">    <span class="n">api</span><span class="o">=...</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 由api请求数据</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=...</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 处理得到数据，生成发送用户的信息</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span><span class="o">=...</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="n">hello_world</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-正式开始其实已经结束了">2 正式开始？——其实已经结束了<a hidden class="anchor" aria-hidden="true" href="#2-正式开始其实已经结束了">#</a></h2>
<h3 id="21-第一步---poke-行为触发">2.1 第一步 - poke 行为触发<a hidden class="anchor" aria-hidden="true" href="#21-第一步---poke-行为触发">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">nonebot.adapters.onebot.v11</span> <span class="kn">import</span> <span class="n">MessageSegment</span><span class="err">，</span><span class="n">PokeNotifyEvent</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">nonebot</span> <span class="kn">import</span> <span class="n">on_notice</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_poke_check</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="n">PokeNotifyEvent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">target_id</span><span class="o">==</span><span class="n">event</span><span class="o">.</span><span class="n">self_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">poke</span><span class="o">=</span><span class="n">on_notice</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">_poke_check</span><span class="p">,</span><span class="n">priority</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@poke.handle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="n">PokeNotifyEvent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="n">poke</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">MessageSegment</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">+</span><span class="n">Message</span><span class="p">(</span><span class="s2">&#34;hi&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是一段检测 poke 行为并进行回复的简易程序，下面我们将对其进行讲解。</p>
<p>首先我们定义了一个用以检验 poke 行为的自定义规则。<code>PokeNotifyEvent</code> 是一个 Poke 事件，当该事件作用的对象为机器人本身时，进入响应器的作用流程。</p>
<p><code>on_notice()</code>注册了一个消息事件响应器。自定义规则通过 rule 传递给响应器，<code>priority</code>指定响应器的作用优先级，<code>block=True</code>时不再响应优先级更低的事件。</p>
<p><code>MessageSegment</code> 是一个非常好用的工具。在 nonebot 中，我们想要发送图片，或@某人等特殊信息，通常使用 CQ 码。<code>MessageSegment</code> 对 CQ 码进行包装，使其更加容易编写。此处我们使用 <code>MessageSegment.at()</code> 函数，实现了@某人的效果。</p>
<p>当我们要实现一个动作时，往往需要提前告知动作作用的对象。<code>event.get_user_id()</code> 返回 string 格式的用户 qq 号。</p>
<p><code>MessageSegment</code>返回一个<code>Message</code>对象，能够和其他<code>Message</code>对象相加，合并成一个消息列表。因此最后发送给用户的信息应当是：“@用户名hi”。</p>
<h3 id="22-第二步---叫我主人大人">2.2 第二步 - 叫我主人大人！<a hidden class="anchor" aria-hidden="true" href="#22-第二步---叫我主人大人">#</a></h3>
<p>有时我们需要从用户发送的消息中抽取有用的信息，并对其进行处理或存储。这通常使用 <code>CommandArg</code> 来实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">call_me</span><span class="o">=</span><span class="n">on_command</span><span class="p">(</span><span class="s2">&#34;叫我&#34;</span><span class="p">,</span><span class="n">rule</span><span class="o">=</span><span class="n">to_me</span><span class="p">()</span><span class="o">&amp;</span> <span class="n">Rule</span><span class="p">(</span><span class="n">is_super_user</span><span class="p">),</span><span class="n">priority</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@call_me.handle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="n">Event</span><span class="p">,</span><span class="n">args</span><span class="p">:</span><span class="n">Message</span><span class="o">=</span><span class="n">CommandArg</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">    <span class="n">arg</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">extract_plain_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">call_me</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">MessageSegment</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">+</span><span class="n">Message</span><span class="p">(</span><span class="s2">&#34;没有那样的称呼啦！&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">oyobi</span><span class="o">=</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">config_file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="si">}</span><span class="s2">/config.json&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span><span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">content</span><span class="o">=</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">content</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">user_id</span><span class="p">,{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&#34;oyobi&#34;</span><span class="p">,</span><span class="n">oyobi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span><span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">content</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">call_me</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">MessageSegment</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">+</span><span class="n">Message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;好的哦，</span><span class="si">{</span><span class="n">oyobi</span><span class="si">}</span><span class="s2">!&#34;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>CommandArg 获取的消息是一个 Message 对象，需要使用 extract. <code>plain_text()</code> 函数返回一个消息字符串。当然你也可以使用 split 方法对这个字符串进行切割，从而返回一个 string 列表。我在上面的示例中就是这样做的。我通过 <code>if else</code> 语句强制规定该响应器只能接受一个参数。</p>
<p><code>oyobi</code> 变量成功保存了接受到的命令参数，接着就是 python 中基本的文件操作。这里你需要掌握的是 json 文件的操作。json 格式文件常用于 nonebot 中的数据保存。由于不需要建立数据库，只需要操作文件，所以方便快捷。对 json 的操作一般包括增删改查，流程大都是通过调用 <code>json.load()</code> 和 <code>json.dump()</code> 两个函数。<code>json.load()</code> 函数用以读取 json 格式信息并转化为字典或列表格式的变量。<code>json.dump()</code> 函数将 python 中的数据格式，如字典或列表转化为 json 格式数据并写入文件中。在要保存的数据中包括 cjk 字符（中文或日文等）的情况下，建议将 <code>json.dump()</code> 函数中的 <code>ensure_ascii</code> 参数置为 <code>False</code>，否则 cjk 字符将被保存为 ascii 码导致阅读困难。</p>
<p>学会json的操作，你就可以写下一个响应器，让机器人叫你你喜欢的名字了（<s>比如ご主人様之类</s>）。</p>
<h3 id="23-第三步---你到底是不是我的主人">2.3 第三步 - 你到底是不是我的主人？<a hidden class="anchor" aria-hidden="true" href="#23-第三步---你到底是不是我的主人">#</a></h3>
<p>说是例子，其实更恰当地来讲不过是工具函数罢了。判断是否超管在实现某些功能时很有必要，比如对你示爱，对其他人冷眼以对的<s>超级棒的</s>机器人。自定义规则适用于响应器中事件的判断，如果你想要对响应器是否执行进行判断（如果不符合，不进入响应器），可以使用 <code>nonebot.rule</code> 中封装好的规则，如<code>to_me</code>等，或 <code>nonebot.permission</code> 中的封装好的权限，如<code>SUPERUSER</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">nonebot</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_super_user</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="n">Event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    判断当前交互对象是否超级管理员
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">()</span> <span class="ow">in</span> <span class="n">nonebot</span><span class="o">.</span><span class="n">get_driver</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">superusers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_not_super_user</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="n">Event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    判断当前交互对象是否不是超级管理员
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nonebot</span><span class="o">.</span><span class="n">get_driver</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">superusers</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>全局配置文件由工程文件夹下的 <code>.env</code> 指定，通常为 <code>.env.dev</code> 或 <code>.env.prod</code>。事实上，读取配置在官网上给出了至少三种方法，我这里只给出一种，其他请自行上官网查看。你可以通过 <code>nonebot.get_driver().config</code>，从驱动器中获取配置文件。值得注意的是，配置文件中的 key 不区分大小写（事实上，一般都用大写），而插件中只能使用小写。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_poke_check</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="n">PokeNotifyEvent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">target_id</span><span class="o">==</span><span class="n">event</span><span class="o">.</span><span class="n">self_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">poke</span><span class="o">=</span><span class="n">on_notice</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">_poke_check</span><span class="p">,</span><span class="n">priority</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@poke.handle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="n">PokeNotifyEvent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_super_user</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">mes</span><span class="o">=</span><span class="n">MessageSegment</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;file:///</span><span class="si">{</span><span class="n">img</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">MessageSegment</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">+</span><span class="n">Message</span><span class="p">(</span><span class="s2">&#34;贴贴～&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">poke</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">mes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">poke</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">MessageSegment</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">+</span><span class="n">Message</span><span class="p">(</span><span class="s2">&#34;滚&#34;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><s>稍稍修改第一个程序即可收获秀恩爱机器人一名，以及所有尝试戳机器人的人的无情谩骂（别问我怎么知道的）</s></p>
<h3 id="24-第四步---好图我的了">2.4 第四步 - 好图，我的了！<a hidden class="anchor" aria-hidden="true" href="#24-第四步---好图我的了">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 图片收集</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_img_check</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_super_user</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get_message</span><span class="p">())</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;[CQ:image&#34;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">to_me</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get_message</span><span class="p">())</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;[CQ:image&#34;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prepare</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">collect</span><span class="o">=</span><span class="n">on_message</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">_img_check</span><span class="p">,</span><span class="n">priority</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@collect.handle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">_collect</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mes</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">get_message</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">pic</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">mes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;http.*]&#34;</span><span class="p">,</span><span class="n">pic</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&#34;]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">uuid_str</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">img_dir_path</span><span class="si">}</span><span class="s2">/default/</span><span class="si">{</span><span class="n">uuid_str</span><span class="si">}</span><span class="s2">.jpg&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">collect</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s2">&#34;好图，我的了&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;糟糕，没能抓到图(QAQ)&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>机器人的自主学习使我们梦寐以求的。偷图虽然离自主学习还很遥远（<s>其实根本八竿子打不着</s>），但偷图依然是一项实用的功能。</p>
<p>现在你已经掌握了编写插件所具有的基本知识，因此我想到了这步，只是提示一下思路就已经足够了。</p>
<p>正如我们前面所说，cq-http 中一些复杂消息类型，如@或图片等均是通过 CQ 码实现的。因此我们接收到的图片应当是类似 <code>[CQ:image,...,url=http://xxx.com/xxx.jpg]</code> 的格式，因此我们可以使用一些方式，如正则或 json 的方式获取消息中的 url，并且利用 request 或着 httpx 将 url 的图片下载到本地。</p>
<h3 id="25-第五步---随机回复">2.5 第五步 - 随机回复<a hidden class="anchor" aria-hidden="true" href="#25-第五步---随机回复">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 随机回复</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_reply_check</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">prepare</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">reply</span><span class="o">=</span><span class="n">on_message</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">_reply_check</span><span class="p">,</span><span class="n">priority</span><span class="o">=</span><span class="mi">130</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@reply.handle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">_reply</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">img_default_list</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">img_dir_path</span><span class="si">}</span><span class="s2">/default&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">img_dir_path</span><span class="si">}</span><span class="s2">/default/</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">img_default_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">reply</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MessageSegment</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;file:///</span><span class="si">{</span><span class="n">img</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;reply不小心出错了诶嘿&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>随机回复一般用于让机器人群聊中加入聊天话题，此功能被证明干扰性较强，因此慎用。不知你有没有注意到，在上个程序中和这个程序中都用到了 <code>prepare()</code> 函数。<code>prepare</code> 函数是我定义的一个工具函数，用以确定触发概率。其定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    概率函数,参数 s 决定概率是 s%
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span> <span class="o">&lt;</span> <span class="n">s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>给出了这个函数，结合你学到的知识，你应该能够轻松看懂这个程序，因此就程序不做讲解了。与之相比，我想要说的是干扰性的问题。我们通常难以对概率有一个清楚的认知，要知道，一般抽卡手游的概率可是2%左右，即使是10%的概率也是天文数字。在一个活跃的群里，10%的概率意味着每隔几秒机器人就会发一次言；但是在一个冷门的群里，大家一天只发一两句话，那么机器人几乎不可能发言。在后一种情况下，这个功能其实可有可无，也不存在干扰的问题；但在前者，我们就需要降低概率，甚至添加冷却时间以防止连续触发。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="https://levinion.github.io/posts/linux%E7%9A%8451%E5%8D%95%E7%89%87%E6%9C%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">
    <span class="title">下一页 »</span>
    <br>
    <span>Linux的51单片机开发环境搭建</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Nonebot2-插件编写入门指北 on twitter"
        href="https://twitter.com/intent/tweet/?text=Nonebot2-%e6%8f%92%e4%bb%b6%e7%bc%96%e5%86%99%e5%85%a5%e9%97%a8%e6%8c%87%e5%8c%97&amp;url=https%3a%2f%2flevinion.github.io%2fposts%2fnonebot2-%25E6%258F%2592%25E4%25BB%25B6%25E7%25BC%2596%25E5%2586%2599%25E5%2585%25A5%25E9%2597%25A8%25E6%258C%2587%25E5%258C%2597%2f&amp;hashtags=">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Nonebot2-插件编写入门指北 on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flevinion.github.io%2fposts%2fnonebot2-%25E6%258F%2592%25E4%25BB%25B6%25E7%25BC%2596%25E5%2586%2599%25E5%2585%25A5%25E9%2597%25A8%25E6%258C%2587%25E5%258C%2597%2f&amp;title=Nonebot2-%e6%8f%92%e4%bb%b6%e7%bc%96%e5%86%99%e5%85%a5%e9%97%a8%e6%8c%87%e5%8c%97&amp;summary=Nonebot2-%e6%8f%92%e4%bb%b6%e7%bc%96%e5%86%99%e5%85%a5%e9%97%a8%e6%8c%87%e5%8c%97&amp;source=https%3a%2f%2flevinion.github.io%2fposts%2fnonebot2-%25E6%258F%2592%25E4%25BB%25B6%25E7%25BC%2596%25E5%2586%2599%25E5%2585%25A5%25E9%2597%25A8%25E6%258C%2587%25E5%258C%2597%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Nonebot2-插件编写入门指北 on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2flevinion.github.io%2fposts%2fnonebot2-%25E6%258F%2592%25E4%25BB%25B6%25E7%25BC%2596%25E5%2586%2599%25E5%2585%25A5%25E9%2597%25A8%25E6%258C%2587%25E5%258C%2597%2f&title=Nonebot2-%e6%8f%92%e4%bb%b6%e7%bc%96%e5%86%99%e5%85%a5%e9%97%a8%e6%8c%87%e5%8c%97">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Nonebot2-插件编写入门指北 on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flevinion.github.io%2fposts%2fnonebot2-%25E6%258F%2592%25E4%25BB%25B6%25E7%25BC%2596%25E5%2586%2599%25E5%2585%25A5%25E9%2597%25A8%25E6%258C%2587%25E5%258C%2597%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Nonebot2-插件编写入门指北 on whatsapp"
        href="https://api.whatsapp.com/send?text=Nonebot2-%e6%8f%92%e4%bb%b6%e7%bc%96%e5%86%99%e5%85%a5%e9%97%a8%e6%8c%87%e5%8c%97%20-%20https%3a%2f%2flevinion.github.io%2fposts%2fnonebot2-%25E6%258F%2592%25E4%25BB%25B6%25E7%25BC%2596%25E5%2586%2599%25E5%2585%25A5%25E9%2597%25A8%25E6%258C%2587%25E5%258C%2597%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Nonebot2-插件编写入门指北 on telegram"
        href="https://telegram.me/share/url?text=Nonebot2-%e6%8f%92%e4%bb%b6%e7%bc%96%e5%86%99%e5%85%a5%e9%97%a8%e6%8c%87%e5%8c%97&amp;url=https%3a%2f%2flevinion.github.io%2fposts%2fnonebot2-%25E6%258F%2592%25E4%25BB%25B6%25E7%25BC%2596%25E5%2586%2599%25E5%2585%25A5%25E9%2597%25A8%25E6%258C%2587%25E5%258C%2597%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://levinion.github.io">Maruka&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
