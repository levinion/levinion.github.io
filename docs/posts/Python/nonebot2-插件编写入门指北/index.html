<!DOCTYPE html>
<html data-theme="dark">
  <head>
    
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/assets/css/pico.css" />
<link rel="stylesheet" href="/assets/css/custom.css" />
<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script> 


    <style>
    article {
      background: rgb(28, 29, 33);
      max-width: 70%;
      text-align: left;
      margin: 0 auto;
      border-radius: 30px;
    }
    p {
      font-size: 18px;
      line-height: 32px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .meta p {
      text-align: center;
    }
    .logo {
      margin-top: 10px;
      margin-left: 30px;
      color: white;
      font-size: x-large;
    }
    .breadcrumb {
      margin-right: 50px;
    }
    .breadcrumb a {
      color: white;
    }
    .date {
      text-align: center;
    }
  </style>
    <title>Nonebot2-æ’ä»¶ç¼–å†™å…¥é—¨æŒ‡åŒ—</title>
  </head>
  <body>
    
<nav>
  <a href="/" class="logo">Maruka's Blog</a>
  <div class="breadcrumb">
    <ul>
      <li>
        <a href="/posts">æ–‡ç« </a>
      </li>
      <li>
        <a href="/category">åˆ†ç±»</a>
      </li>
      <li>
        <a href="/about">å…³äº</a>
      </li>
    </ul>
  </div>
</nav>

    <div>
      <div class="meta">
        <h1>Nonebot2-æ’ä»¶ç¼–å†™å…¥é—¨æŒ‡åŒ—</h1>
        <p>2022-11-29 13:37:42</p>
      </div>
      <article><h2>ğŸ˜‡æŒ‡åŒ—è¯·æ³¨æ„</h2>
<p>nonebot2 æ˜¯ä¸€ä¸ªç”± python ç¼–å†™çš„è·¨å¹³å°å¼‚æ­¥æœºå™¨äººæ¡†æ¶ï¼Œå¯¹é‚£äº›æƒ³æ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„æœºå™¨äººçš„äººæ¥è¯´ï¼Œnonebot2 æ˜¯ä¸€ä¸ªç†æƒ³çš„é€‰æ‹©ã€‚nonebot2 å­¦ä¹ é—¨æ§›ä¸é«˜â€”â€”ä½ æ‰€éœ€è¦çš„åªæ˜¯ä¸€äº› python åŸºç¡€ã€‚å¦‚æœä½ æ²¡æœ‰å­¦è¿‡ pythonï¼Œä½†æœ‰å…¶ä»–ç¼–ç¨‹è¯­è¨€åŸºç¡€ï¼Œé‚£ä¹Ÿæ²¡æœ‰å…³ç³»ï¼›å› ä¸ºæˆ‘ä¹Ÿå°†è¿‘ä¸€å¹´å¤šæ²¡æœ‰æ¥è§¦è¿‡ python ç¼–ç¨‹ï¼Œå’Œåˆå­¦è€…æ²¡æœ‰ä»€ä¹ˆä¸¤æ ·ï¼Œå› æ­¤<!-- raw HTML omitted -->å¦‚æœä»£ç ç¨€çƒ‚çš„è¯è¿˜è¯·å¤šå¤šè°…è§£<!-- raw HTML omitted -->ã€‚</p>
<p>å†™è¿™ç¯‡æ–‡ç« çš„éƒ¨åˆ†åŸå› æ˜¯å› ä¸ºå®˜ç½‘çš„æ•™ç¨‹è¿‡äºç®€çº¦ï¼ˆï¼Ÿï¼‰æˆ–é›¶ç¢ï¼Œè€Œä¸”å°‘æœ‰ä»£ç èŒƒä¾‹ï¼Œå¯¹æƒ³è¦æ·±å…¥å®è·µç¼–å†™æ’ä»¶çš„äººé€ æˆäº†ä¸€å®šå›°éš¾ï¼›å¦ä¸€éƒ¨åˆ†ä¹Ÿæ˜¯ä½œä¸ºè¿™å‡ å¤©ç¼–å†™æ’ä»¶ç»éªŒçš„æ€»ç»“ã€‚æœ¬æ–‡é£æ ¼åé‡å®è·µï¼Œå¹¶ä¸æ‰“ç®—äº‹æ— å·¨ç»†åœ°è®²æ¸…æ¥šå†…åœ¨åŸç†ï¼›è¿™å…¶å®æ˜¯æˆ‘çŸ¥è¯†ä¸è¶³çš„åŸå› ã€‚å› æ­¤å¦‚æœæƒ³è¦åŒæ—¶ææ¸…æ¥šç†è®ºçš„è¯ï¼Œæˆ‘ä¼šå°½é‡ç»™å‡ºå‚è€ƒçš„é“¾æ¥ã€‚å¦‚æœæ­£åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« çš„ä½ èƒ½å¤ŸçŸ¥é“â€œæˆ‘å†™è¿™ç¯‡æ–‡ç« çš„åŒæ—¶ä¹Ÿæ˜¯åœ¨å’Œä½ ä¸€åŒå­¦ä¹ â€çš„è¯ï¼Œé‚£å¯å°±å¤ªå¥½äº†ã€‚</p>
<p><!-- raw HTML omitted -->&gt; åœ¨æ­£æ–‡å¼€å§‹å‰ï¼Œä½ åº”å½“å·²ç»åšåˆ°äº†ä»¥ä¸‹å‡ ç‚¹ï¼š<!-- raw HTML omitted --></p>
<ul>
<li><input disabled="" type="checkbox"> <!-- raw HTML omitted --> å·²ç»é…ç½®å¥½ nonebot2 å¼€å‘ç¯å¢ƒ<!-- raw HTML omitted --></li>
<li><input disabled="" type="checkbox"> <!-- raw HTML omitted --> å…·å¤‡ä¸€å®šçš„ python åŸºç¡€ï¼ˆå¦‚æœæœ‰å…¶ä»–ç¼–ç¨‹è¯­è¨€ç»éªŒï¼Œè‡³å°‘å…·å¤‡æŸ¥é˜…èµ„æ–™çš„èƒ½åŠ›ï¼‰<!-- raw HTML omitted --></li>
<li><input disabled="" type="checkbox"> <!-- raw HTML omitted --> ç§¯æåŠ¨æ‰‹å®è·µ<!-- raw HTML omitted --></li>
</ul>
<p><!-- raw HTML omitted -->&gt;è¿™ç¯‡æ–‡ç« çš„å¤§ä½“æ€è·¯å¦‚ä¸‹ï¼š<!-- raw HTML omitted --></p>
<ol>
<li>Hello World</li>
<li>ä»¥æˆ‘è‡ªå·±ç¼–å†™çš„æ’ä»¶ â€œsumiâ€ ä¸ºä¾‹ï¼Œä½ èƒ½å¤Ÿå­¦ä¼šï¼š</li>
</ol>
<ul>
<li>å¯¹æˆ³ä¸€æˆ³äº‹ä»¶çš„å›åº”</li>
<li>å‘½ä»¤å‚æ•°</li>
<li>è‡ªå®šä¹‰è§„åˆ™</li>
<li>è¯»å–ç¯å¢ƒé…ç½®</li>
<li>json ä¿å­˜å’Œè¯»å–æ•°æ®</li>
<li>å‘é€å’Œä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°ï¼ˆæ²¡é”™ï¼Œå°±æ˜¯å·å›¾åŠŸèƒ½å“’ï¼ï¼‰</li>
</ul>
<p>è¡Œäº†ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚</p>
<h2>1 ğŸŠHello World</h2>
<p>æ­£å¦‚æ¯ç§è¯­è¨€éƒ½ä»è¾“å‡º &quot;hello world&quot; å¼€å§‹é‚£æ ·ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ’ä»¶å°è¯•è®© bot å‘é€ä¸€æ¡ &quot;hello world&quot; ä¿¡æ¯ç»™ç”¨æˆ·ã€‚</p>
<h3>1.1 å‡†å¤‡ - é¡¹ç›®æ–‡ä»¶ç»“æ„</h3>
<p>åœ¨å¼€å§‹æ­£å¼ç¼–å†™æ’ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹æ’ä»¶ç¼–å†™çš„æ–‡ä»¶ç»“æ„ã€‚</p>
<pre><code>.  
â”œâ”€â”€ bot.py  
â”œâ”€â”€ docker-compose.yml  
â”œâ”€â”€ Dockerfile  
â”œâ”€â”€ firststep  
â”‚Â Â Â â””â”€â”€ plugins  
â”œâ”€â”€ pyproject.toml  
â””â”€â”€ README.md
</code></pre>
<p>è¿™æ˜¯åˆšåˆšåˆ›å»ºé¡¹ç›®æ—¶æ‰€å…·æœ‰çš„æœ€ç®€æ–‡ä»¶ç»“æ„ã€‚æˆ‘ä»¬æ‰€ç¼–å†™çš„æ’ä»¶åº”å½“æ”¾åœ¨ <code>{é¡¹ç›®å}/plugins</code> æ–‡ä»¶å¤¹ä¸‹ã€‚ <code>bot.py</code> æ˜¯ç¨‹åºçš„å…¥å£ï¼Œè´Ÿè´£æ’ä»¶çš„è°ƒç”¨ã€‚</p>
<pre><code>.  
â””â”€â”€ plugins  
Â Â Â â””â”€â”€ hello_world  
Â Â Â Â Â Â Â â””â”€â”€ __init__.py
</code></pre>
<p>é¦–å…ˆåœ¨ <code>plugins</code> ç›®å½•ä¸‹åˆ›å»ºåä¸º <code>hello_world</code> çš„æ–‡ä»¶å¤¹ï¼Œæ­¤å³æ’ä»¶åç§°ï¼›æ’ä»¶ä¸»ç¨‹åºä¸€èˆ¬å‘½åä¸º <code>__init__.py</code> ã€‚</p>
<blockquote>
<p>å¦‚æœä½ æƒ³è¦å°†æ’ä»¶å‘å¸ƒåˆ°å•†åº—ï¼ŒæŒ‰ç…§è§„èŒƒï¼Œæ’ä»¶åç§°åº”å½“ä»¥ <code>nonebot-plugin-</code> æˆ– <code>nonebot_plugin_</code> å¼€å¤´ï¼Œæœ¬æ–‡ä¸ºç»ƒä¹ æ–¹ä¾¿èµ·è§ï¼Œä¸éµå¾ªæ­¤è§„å®šã€‚</p>
</blockquote>
<h3>1.2 å§‹åŠ¨ - hello world ç¨‹åº</h3>
<pre><code class="language-python">from nonebot import on_command

hello_world = on_command(&quot;hi&quot;)
@hello_world.handle()
async def _():
    await hello_world.send(&quot;hello world&quot;)
</code></pre>
<p>çŸ­çŸ­å…­è¡Œä»£ç å³å¯å®Œæˆæ•´ä¸ªå·¥ä½œæµï¼ˆè¯·å¿½ç•¥ä¸­é—´çš„é‚£ä¸ªç©ºè¡Œå–µï¼‰ï¼š</p>
<ol>
<li>å“åº”å™¨æ¥æ”¶åˆ°ç”¨æˆ·å‘é€çš„æŒ‡ä»¤ â€œhiâ€ï¼›</li>
<li>é€šè¿‡ <code>handle</code> è£…é¥°å™¨è¿›å…¥åˆ°æ’ä»¶çš„è¿è¡Œæµç¨‹ï¼›</li>
<li>ç„¶åå¼‚æ­¥å‡½æ•°å‘ç”¨æˆ·å‘é€ä¿¡æ¯ã€‚</li>
</ol>
<p>å…·ä½“çš„å“åº”å™¨ç±»å‹è¯·å‚è€ƒå®˜ç½‘å†…å®¹â€”â€” <a href="https://nb2.baka.icu/docs/tutorial/plugin/create-matcher">å®šä¹‰äº‹ä»¶å“åº”å™¨</a>ã€‚</p>
<h3>1.3 è¿›é˜¶ - ç”± hello world è¿‡æ¸¡åˆ°å®ç”¨æ’ä»¶</h3>
<p>é€šè¿‡ä»¥ä¸Šä»£ç ï¼Œæˆ‘ä»¬å·²ç»å®ç° bot å‘ç”¨æˆ·å‘é€ä¿¡æ¯ã€‚å¦‚æœåŠ ä¸Šäº‹ä»¶å¤„ç†ï¼Œå°±èƒ½å¤Ÿå®ç°æ›´å¤šå®ç”¨åŠŸèƒ½ã€‚</p>
<pre><code class="language-python">import ...

hello_world = on_command(...)
@hello_world.handle()
async def _():
    # è¿”å›æ•°æ®çš„è¯·æ±‚api
    api=...
    # ç”±apiè¯·æ±‚æ•°æ®
    ...
    data=...
    # å¤„ç†å¾—åˆ°æ•°æ®ï¼Œç”Ÿæˆå‘é€ç”¨æˆ·çš„ä¿¡æ¯
    ...
    message=...
    await hello_world.send(message)
</code></pre>
<h2>2 ğŸ¦´æ­£å¼å¼€å§‹ï¼Ÿâ€”â€”å…¶å®å·²ç»ç»“æŸäº†</h2>
<h3>2.1 ç¬¬ä¸€æ­¥ - poke è¡Œä¸ºè§¦å‘</h3>
<pre><code class="language-python">from nonebot.adapters.onebot.v11 import MessageSegmentï¼ŒPokeNotifyEvent
from nonebot import on_notice

def _poke_check(event:PokeNotifyEvent):
    return event.target_id==event.self_id

poke=on_notice(rule=_poke_check,priority=5,block=True)
@poke.handle()
async def _(event:PokeNotifyEvent):
    user_id=event.get_user_id()
    await poke.finish(MessageSegment.at(user_id)+Message(&quot;hi&quot;)
</code></pre>
<p>è¿™æ˜¯ä¸€æ®µæ£€æµ‹ poke è¡Œä¸ºå¹¶è¿›è¡Œå›å¤çš„ç®€æ˜“ç¨‹åºï¼Œä¸‹é¢æˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œè®²è§£ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç”¨ä»¥æ£€éªŒ poke è¡Œä¸ºçš„è‡ªå®šä¹‰è§„åˆ™ã€‚<code>PokeNotifyEvent</code> æ˜¯ä¸€ä¸ª Poke äº‹ä»¶ï¼Œå½“è¯¥äº‹ä»¶ä½œç”¨çš„å¯¹è±¡ä¸ºæœºå™¨äººæœ¬èº«æ—¶ï¼Œè¿›å…¥å“åº”å™¨çš„ä½œç”¨æµç¨‹ã€‚</p>
<p><code>on_notice()</code>æ³¨å†Œäº†ä¸€ä¸ªæ¶ˆæ¯äº‹ä»¶å“åº”å™¨ã€‚è‡ªå®šä¹‰è§„åˆ™é€šè¿‡ rule ä¼ é€’ç»™å“åº”å™¨ï¼Œ<code>priority</code>æŒ‡å®šå“åº”å™¨çš„ä½œç”¨ä¼˜å…ˆçº§ï¼Œ<code>block=True</code>æ—¶ä¸å†å“åº”ä¼˜å…ˆçº§æ›´ä½çš„äº‹ä»¶ã€‚</p>
<p><code>MessageSegment</code> æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å·¥å…·ã€‚åœ¨ nonebot ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦å‘é€å›¾ç‰‡ï¼Œæˆ–@æŸäººç­‰ç‰¹æ®Šä¿¡æ¯ï¼Œé€šå¸¸ä½¿ç”¨ CQ ç ã€‚<code>MessageSegment</code> å¯¹ CQ ç è¿›è¡ŒåŒ…è£…ï¼Œä½¿å…¶æ›´åŠ å®¹æ˜“ç¼–å†™ã€‚æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨ <code>MessageSegment.at()</code> å‡½æ•°ï¼Œå®ç°äº†@æŸäººçš„æ•ˆæœã€‚</p>
<p>å½“æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªåŠ¨ä½œæ—¶ï¼Œå¾€å¾€éœ€è¦æå‰å‘ŠçŸ¥åŠ¨ä½œä½œç”¨çš„å¯¹è±¡ã€‚<code>event.get_user_id()</code> è¿”å› string æ ¼å¼çš„ç”¨æˆ· qq å·ã€‚</p>
<p><code>MessageSegment</code>è¿”å›ä¸€ä¸ª<code>Message</code>å¯¹è±¡ï¼Œèƒ½å¤Ÿå’Œå…¶ä»–<code>Message</code>å¯¹è±¡ç›¸åŠ ï¼Œåˆå¹¶æˆä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨ã€‚å› æ­¤æœ€åå‘é€ç»™ç”¨æˆ·çš„ä¿¡æ¯åº”å½“æ˜¯ï¼šâ€œ@ç”¨æˆ·åhiâ€ã€‚</p>
<h3>2.2 ç¬¬äºŒæ­¥ - å«æˆ‘ä¸»äººå¤§äººï¼</h3>
<p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦ä»ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ä¸­æŠ½å–æœ‰ç”¨çš„ä¿¡æ¯ï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¤„ç†æˆ–å­˜å‚¨ã€‚è¿™é€šå¸¸ä½¿ç”¨ <code>CommandArg</code> æ¥å®ç°ã€‚</p>
<pre><code class="language-python">call_me=on_command(&quot;å«æˆ‘&quot;,rule=to_me()&amp; Rule(is_super_user),priority=8)
@call_me.handle()
async def _(event:Event,args:Message=CommandArg()):
    arg:List[str]=args.extract_plain_text().strip().split()
    user_id=event.get_user_id()
    if len(arg)!=1:
        await call_me.finish(MessageSegment.at(user_id)+Message(&quot;æ²¡æœ‰é‚£æ ·çš„ç§°å‘¼å•¦ï¼&quot;))
    else:
        oyobi=arg[0]
        config_file=f&quot;{os.path.dirname(__file__)}/config.json&quot;
        with open(config_file,&quot;r&quot;) as file:
            try:
                content=json.load(file)
            except:
                content={}
        content.setdefault(user_id,{}).setdefault(&quot;oyobi&quot;,oyobi)
        with open(config_file,&quot;w&quot;) as file:
            json.dump(content,file,ensure_ascii=False)
        await call_me.finish(MessageSegment.at(user_id)+Message(f&quot;å¥½çš„å“¦ï¼Œ{oyobi}!&quot;))

</code></pre>
<p>CommandArg è·å–çš„æ¶ˆæ¯æ˜¯ä¸€ä¸ª Message å¯¹è±¡ï¼Œéœ€è¦ä½¿ç”¨ extract. <code>plain_text()</code> å‡½æ•°è¿”å›ä¸€ä¸ªæ¶ˆæ¯å­—ç¬¦ä¸²ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ split æ–¹æ³•å¯¹è¿™ä¸ªå­—ç¬¦ä¸²è¿›è¡Œåˆ‡å‰²ï¼Œä»è€Œè¿”å›ä¸€ä¸ª string åˆ—è¡¨ã€‚æˆ‘åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­å°±æ˜¯è¿™æ ·åšçš„ã€‚æˆ‘é€šè¿‡ <code>if else</code> è¯­å¥å¼ºåˆ¶è§„å®šè¯¥å“åº”å™¨åªèƒ½æ¥å—ä¸€ä¸ªå‚æ•°ã€‚</p>
<p><code>oyobi</code> å˜é‡æˆåŠŸä¿å­˜äº†æ¥å—åˆ°çš„å‘½ä»¤å‚æ•°ï¼Œæ¥ç€å°±æ˜¯ python ä¸­åŸºæœ¬çš„æ–‡ä»¶æ“ä½œã€‚è¿™é‡Œä½ éœ€è¦æŒæ¡çš„æ˜¯ json æ–‡ä»¶çš„æ“ä½œã€‚json æ ¼å¼æ–‡ä»¶å¸¸ç”¨äº nonebot ä¸­çš„æ•°æ®ä¿å­˜ã€‚ç”±äºä¸éœ€è¦å»ºç«‹æ•°æ®åº“ï¼Œåªéœ€è¦æ“ä½œæ–‡ä»¶ï¼Œæ‰€ä»¥æ–¹ä¾¿å¿«æ·ã€‚å¯¹ json çš„æ“ä½œä¸€èˆ¬åŒ…æ‹¬å¢åˆ æ”¹æŸ¥ï¼Œæµç¨‹å¤§éƒ½æ˜¯é€šè¿‡è°ƒç”¨ <code>json.load()</code> å’Œ <code>json.dump()</code> ä¸¤ä¸ªå‡½æ•°ã€‚<code>json.load()</code> å‡½æ•°ç”¨ä»¥è¯»å– json æ ¼å¼ä¿¡æ¯å¹¶è½¬åŒ–ä¸ºå­—å…¸æˆ–åˆ—è¡¨æ ¼å¼çš„å˜é‡ã€‚<code>json.dump()</code> å‡½æ•°å°† python ä¸­çš„æ•°æ®æ ¼å¼ï¼Œå¦‚å­—å…¸æˆ–åˆ—è¡¨è½¬åŒ–ä¸º json æ ¼å¼æ•°æ®å¹¶å†™å…¥æ–‡ä»¶ä¸­ã€‚åœ¨è¦ä¿å­˜çš„æ•°æ®ä¸­åŒ…æ‹¬ cjk å­—ç¬¦ï¼ˆä¸­æ–‡æˆ–æ—¥æ–‡ç­‰ï¼‰çš„æƒ…å†µä¸‹ï¼Œå»ºè®®å°† <code>json.dump()</code> å‡½æ•°ä¸­çš„ <code>ensure_ascii</code> å‚æ•°ç½®ä¸º <code>False</code>ï¼Œå¦åˆ™ cjk å­—ç¬¦å°†è¢«ä¿å­˜ä¸º ascii ç å¯¼è‡´é˜…è¯»å›°éš¾ã€‚</p>
<p>å­¦ä¼šjsonçš„æ“ä½œï¼Œä½ å°±å¯ä»¥å†™ä¸‹ä¸€ä¸ªå“åº”å™¨ï¼Œè®©æœºå™¨äººå«ä½ ä½ å–œæ¬¢çš„åå­—äº†ï¼ˆ<del>æ¯”å¦‚ã”ä¸»äººæ§˜ä¹‹ç±»</del>ï¼‰ã€‚</p>
<h3>2.3 ç¬¬ä¸‰æ­¥ - ä½ åˆ°åº•æ˜¯ä¸æ˜¯æˆ‘çš„ä¸»äººï¼Ÿ</h3>
<p>è¯´æ˜¯ä¾‹å­ï¼Œå…¶å®æ›´æ°å½“åœ°æ¥è®²ä¸è¿‡æ˜¯å·¥å…·å‡½æ•°ç½¢äº†ã€‚åˆ¤æ–­æ˜¯å¦è¶…ç®¡åœ¨å®ç°æŸäº›åŠŸèƒ½æ—¶å¾ˆæœ‰å¿…è¦ï¼Œæ¯”å¦‚å¯¹ä½ ç¤ºçˆ±ï¼Œå¯¹å…¶ä»–äººå†·çœ¼ä»¥å¯¹çš„<!-- raw HTML omitted -->è¶…çº§æ£’çš„<!-- raw HTML omitted -->æœºå™¨äººã€‚è‡ªå®šä¹‰è§„åˆ™é€‚ç”¨äºå“åº”å™¨ä¸­äº‹ä»¶çš„åˆ¤æ–­ï¼Œå¦‚æœä½ æƒ³è¦å¯¹å“åº”å™¨æ˜¯å¦æ‰§è¡Œè¿›è¡Œåˆ¤æ–­ï¼ˆå¦‚æœä¸ç¬¦åˆï¼Œä¸è¿›å…¥å“åº”å™¨ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>nonebot.rule</code> ä¸­å°è£…å¥½çš„è§„åˆ™ï¼Œå¦‚<code>to_me</code>ç­‰ï¼Œæˆ– <code>nonebot.permission</code> ä¸­çš„å°è£…å¥½çš„æƒé™ï¼Œå¦‚<code>SUPERUSER</code>ã€‚</p>
<pre><code class="language-python">import nonebot

def is_super_user(event:Event):
    &quot;&quot;&quot;
    åˆ¤æ–­å½“å‰äº¤äº’å¯¹è±¡æ˜¯å¦è¶…çº§ç®¡ç†å‘˜
    &quot;&quot;&quot;
    return event.get_user_id() in nonebot.get_driver().config.superusers

def is_not_super_user(event:Event):
    &quot;&quot;&quot;
    åˆ¤æ–­å½“å‰äº¤äº’å¯¹è±¡æ˜¯å¦ä¸æ˜¯è¶…çº§ç®¡ç†å‘˜
    &quot;&quot;&quot;
    return event.get_user_id() not in nonebot.get_driver().config.superusers
</code></pre>
<p>å…¨å±€é…ç½®æ–‡ä»¶ç”±å·¥ç¨‹æ–‡ä»¶å¤¹ä¸‹çš„ <code>.env</code> æŒ‡å®šï¼Œé€šå¸¸ä¸º <code>.env.dev</code> æˆ– <code>.env.prod</code>ã€‚äº‹å®ä¸Šï¼Œè¯»å–é…ç½®åœ¨å®˜ç½‘ä¸Šç»™å‡ºäº†è‡³å°‘ä¸‰ç§æ–¹æ³•ï¼Œæˆ‘è¿™é‡Œåªç»™å‡ºä¸€ç§ï¼Œå…¶ä»–è¯·è‡ªè¡Œä¸Šå®˜ç½‘æŸ¥çœ‹ã€‚ä½ å¯ä»¥é€šè¿‡ <code>nonebot.get_driver().config</code>ï¼Œä»é©±åŠ¨å™¨ä¸­è·å–é…ç½®æ–‡ä»¶ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé…ç½®æ–‡ä»¶ä¸­çš„ key ä¸åŒºåˆ†å¤§å°å†™ï¼ˆäº‹å®ä¸Šï¼Œä¸€èˆ¬éƒ½ç”¨å¤§å†™ï¼‰ï¼Œè€Œæ’ä»¶ä¸­åªèƒ½ä½¿ç”¨å°å†™ã€‚</p>
<pre><code class="language-python">def _poke_check(event:PokeNotifyEvent):
    return event.target_id==event.self_id

poke=on_notice(rule=_poke_check,priority=5)
@poke.handle()
async def _(event:PokeNotifyEvent):
    user_id=event.get_user_id()
    if is_super_user(event):
        mes=MessageSegment.image(f&quot;file:///{img}&quot;)+MessageSegment.at(user_id)+Message(&quot;è´´è´´ï½&quot;)
        await poke.finish(mes)
    else:
        await poke.finish(MessageSegment.at(user_id)+Message(&quot;æ»š&quot;))
</code></pre>
<p><del>ç¨ç¨ä¿®æ”¹ç¬¬ä¸€ä¸ªç¨‹åºå³å¯æ”¶è·ç§€æ©çˆ±æœºå™¨äººä¸€åï¼Œä»¥åŠæ‰€æœ‰å°è¯•æˆ³æœºå™¨äººçš„äººçš„æ— æƒ…è°©éª‚ï¼ˆåˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„ï¼‰</del></p>
<h3>2.4 ç¬¬å››æ­¥ - å¥½å›¾ï¼Œæˆ‘çš„äº†ï¼</h3>
<pre><code class="language-python"># å›¾ç‰‡æ”¶é›†
def _img_check(event: Event):
    if is_super_user(event):
        return str(event.get_message()).startswith(&quot;[CQ:image&quot;) and to_me()
    else:
        return str(event.get_message()).startswith(&quot;[CQ:image&quot;) and prepare(60)

collect=on_message(rule=_img_check,priority=100,block=True)
@collect.handle()
async def _collect(event: Event):
    try:
        mes=event.get_message()
        pic=str(mes)
        url=re.search(r&quot;http.*]&quot;,pic).group().removesuffix(&quot;]&quot;)
        uuid_str = uuid.uuid4().hex
        r=httpx.get(url)
        img=f&quot;{img_dir_path}/default/{uuid_str}.jpg&quot;
        with open(img,&quot;wb&quot;) as file:
            file.write(r.content)
        await collect.finish(&quot;å¥½å›¾ï¼Œæˆ‘çš„äº†&quot;)
    except:
        logger.error(&quot;ç³Ÿç³•ï¼Œæ²¡èƒ½æŠ“åˆ°å›¾(QAQ)&quot;)
</code></pre>
<p>æœºå™¨äººçš„è‡ªä¸»å­¦ä¹ ä½¿æˆ‘ä»¬æ¢¦å¯ä»¥æ±‚çš„ã€‚å·å›¾è™½ç„¶ç¦»è‡ªä¸»å­¦ä¹ è¿˜å¾ˆé¥è¿œï¼ˆ<del>å…¶å®æ ¹æœ¬å…«ç«¿å­æ‰“ä¸ç€</del>ï¼‰ï¼Œä½†å·å›¾ä¾ç„¶æ˜¯ä¸€é¡¹å®ç”¨çš„åŠŸèƒ½ã€‚</p>
<p>ç°åœ¨ä½ å·²ç»æŒæ¡äº†ç¼–å†™æ’ä»¶æ‰€å…·æœ‰çš„åŸºæœ¬çŸ¥è¯†ï¼Œå› æ­¤æˆ‘æƒ³åˆ°äº†è¿™æ­¥ï¼Œåªæ˜¯æç¤ºä¸€ä¸‹æ€è·¯å°±å·²ç»è¶³å¤Ÿäº†ã€‚</p>
<p>æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è¯´ï¼Œcq-http ä¸­ä¸€äº›å¤æ‚æ¶ˆæ¯ç±»å‹ï¼Œå¦‚@æˆ–å›¾ç‰‡ç­‰å‡æ˜¯é€šè¿‡ CQ ç å®ç°çš„ã€‚å› æ­¤æˆ‘ä»¬æ¥æ”¶åˆ°çš„å›¾ç‰‡åº”å½“æ˜¯ç±»ä¼¼ <code>[CQ:image,...,url=http://xxx.com/xxx.jpg]</code> çš„æ ¼å¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›æ–¹å¼ï¼Œå¦‚æ­£åˆ™æˆ– json çš„æ–¹å¼è·å–æ¶ˆæ¯ä¸­çš„ urlï¼Œå¹¶ä¸”åˆ©ç”¨ request æˆ–ç€ httpx å°† url çš„å›¾ç‰‡ä¸‹è½½åˆ°æœ¬åœ°ã€‚</p>
<h3>2.5 ç¬¬äº”æ­¥ - éšæœºå›å¤</h3>
<pre><code class="language-python"># éšæœºå›å¤
def _reply_check():
    return prepare(10)

reply=on_message(rule=_reply_check,priority=130)
@reply.handle()
async def _reply():
    try:
        img_default_list=os.listdir(f&quot;{img_dir_path}/default&quot;)
        img=f&quot;{img_dir_path}/default/{random.choice(img_default_list)}&quot;
        await reply.send(MessageSegment.image(f&quot;file:///{img}&quot;))
    except:
        logger.error(&quot;replyä¸å°å¿ƒå‡ºé”™äº†è¯¶å˜¿&quot;)
</code></pre>
<p>éšæœºå›å¤ä¸€èˆ¬ç”¨äºè®©æœºå™¨äººç¾¤èŠä¸­åŠ å…¥èŠå¤©è¯é¢˜ï¼Œæ­¤åŠŸèƒ½è¢«è¯æ˜å¹²æ‰°æ€§è¾ƒå¼ºï¼Œå› æ­¤æ…ç”¨ã€‚ä¸çŸ¥ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œåœ¨ä¸Šä¸ªç¨‹åºä¸­å’Œè¿™ä¸ªç¨‹åºä¸­éƒ½ç”¨åˆ°äº† <code>prepare()</code> å‡½æ•°ã€‚<code>prepare</code> å‡½æ•°æ˜¯æˆ‘å®šä¹‰çš„ä¸€ä¸ªå·¥å…·å‡½æ•°ï¼Œç”¨ä»¥ç¡®å®šè§¦å‘æ¦‚ç‡ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">def prepare(s:int=10):
    &quot;&quot;&quot;
    æ¦‚ç‡å‡½æ•°,å‚æ•° s å†³å®šæ¦‚ç‡æ˜¯ s%
    &quot;&quot;&quot;
    return random.random()*100 &lt; s
</code></pre>
<p>ç»™å‡ºäº†è¿™ä¸ªå‡½æ•°ï¼Œç»“åˆä½ å­¦åˆ°çš„çŸ¥è¯†ï¼Œä½ åº”è¯¥èƒ½å¤Ÿè½»æ¾çœ‹æ‡‚è¿™ä¸ªç¨‹åºï¼Œå› æ­¤å°±ç¨‹åºä¸åšè®²è§£äº†ã€‚ä¸ä¹‹ç›¸æ¯”ï¼Œæˆ‘æƒ³è¦è¯´çš„æ˜¯å¹²æ‰°æ€§çš„é—®é¢˜ã€‚æˆ‘ä»¬é€šå¸¸éš¾ä»¥å¯¹æ¦‚ç‡æœ‰ä¸€ä¸ªæ¸…æ¥šçš„è®¤çŸ¥ï¼Œè¦çŸ¥é“ï¼Œä¸€èˆ¬æŠ½å¡æ‰‹æ¸¸çš„æ¦‚ç‡å¯æ˜¯ 2%å·¦å³ï¼Œå³ä½¿æ˜¯ 10%çš„æ¦‚ç‡ä¹Ÿæ˜¯å¤©æ–‡æ•°å­—ã€‚åœ¨ä¸€ä¸ªæ´»è·ƒçš„ç¾¤é‡Œï¼Œ10%çš„æ¦‚ç‡æ„å‘³ç€æ¯éš”å‡ ç§’æœºå™¨äººå°±ä¼šå‘ä¸€æ¬¡è¨€ï¼›ä½†æ˜¯åœ¨ä¸€ä¸ªå†·é—¨çš„ç¾¤é‡Œï¼Œå¤§å®¶ä¸€å¤©åªå‘ä¸€ä¸¤å¥è¯ï¼Œé‚£ä¹ˆæœºå™¨äººå‡ ä¹ä¸å¯èƒ½å‘è¨€ã€‚åœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸ªåŠŸèƒ½å…¶å®å¯æœ‰å¯æ— ï¼Œä¹Ÿä¸å­˜åœ¨å¹²æ‰°çš„é—®é¢˜ï¼›ä½†åœ¨å‰è€…ï¼Œæˆ‘ä»¬å°±éœ€è¦é™ä½æ¦‚ç‡ï¼Œç”šè‡³æ·»åŠ å†·å´æ—¶é—´ä»¥é˜²æ­¢è¿ç»­è§¦å‘ã€‚</p>
</article>
    </div>
  </body>
</html>
